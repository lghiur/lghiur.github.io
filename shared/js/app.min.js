var buildApp=angular.module("buildApp",[]);buildApp.config(function($provide){$provide.decorator("$httpBackend",angular.mock.e2e.$httpBackendDecorator)}),buildApp.run(["$httpBackend",function($httpBackend){$httpBackend.whenGET("/buildList").respond(buildList),$httpBackend.whenGET("/buildList/item").respond(buildItemResults)}]),angular.module("buildApp").run(["$templateCache",function($templateCache){"use strict";$templateCache.put("buildItem/html/default.tmpl",'<div ng-class="{loading: itemType.status === \'pending\'}" class="grid table-row {{itemType.status}}-theme"><div class="table-col col-1-5"><a href=# title=Tenrox-R1_1235 class=process-btn ng-click=displayResults(itemType);><span class=icon-{{itemType.type}}></span><span class=process-name>{{itemType.id}}</span></a></div><div class="table-col col-1-10"><a href=# title=owner>{{itemType.owner || \'-\'}}</a></div><div class="table-col col-1-5">{{itemType.timeStarted || \'-\'}}</div><div class="table-col col-1-10">{{itemType.status || \'-\'}}</div><loader item-jobs=itemType.jobs.metrics></loader><loader item-jobs=itemType.jobs.build></loader><loader item-jobs=itemType.jobs.unitTest></loader><loader item-jobs=itemType.jobs.functionalTest></loader><item-details item-data=itemType></item-details></div>'),$templateCache.put("buildList/html/default.tmpl",'<section class=table-container><header class="grid table-header"><span class="table-col col-1-5">Changelist/Build</span> <span class="table-col col-1-10">Owner</span> <span class="table-col col-1-5">Time Started</span> <span class="table-col col-1-10">State</span> <span class="table-col col-1-10">Metrics</span> <span class="table-col col-1-10">Build</span> <span class="table-col col-1-10">Unit Test</span> <span class="table-col col-1-10">Functional Test</span></header><build-item ng-repeat-start="build in buildList" item-type=build on-expand=displayResults ng-model=buildList></build-item><build-item ng-repeat-end ng-repeat="firewall in build.firewalls" item-type=firewall on-expand=displayResults ng-model=buildList></build-item></section>'),$templateCache.put("itemDetails/html/default.tmpl",'<div ng-class="{hidden: !itemData.expanded}" class="col results"><div class="col-1-5 metrics"><div class=fail><div class="result-box red">{{itemData.results.metrics.text}}</div></div></div><div class="col-1-5 build"><div class=success><div class="result-box green">{{itemData.results.build.text}}</div></div></div><div class="col-1-5 unit-test"><div class=success><div class="result-box green">{{itemData.results.unitTest.text}}</div></div></div><div class="col-1-5 functional-test"><div class=success><div class="result-box green">{{itemData.results.functionalTest.text}}</div></div></div><div class="col-1-5 conclusion"><div class=success><div class="result-box green">box</div></div></div></div>'),$templateCache.put("loader/html/default.tmpl",'<div class="table-col col-1-10"><span class="loading-box {{itemJobs.status}}"><span ng-style="{width: itemJobs.percentage + \'%\'}"></span></span></div>'),$templateCache.put("modal/html/default.tmpl",'<div ng-class="{opened: modalOpened}" class=modal-wrapper><div class=modal-content><p>{{textMessage}}</p><div class=button><a ng-click=closeModal()>OK</a></div></div></div>')}]),buildApp.controller("mainController",["$scope","$rootScope",function($scope,$rootScope){function init(){bindEvents()}function bindEvents(){$rootScope.$on("modal:open",function(){$scope.modalOpened=!0}),$rootScope.$on("modal:closed",function(){$scope.modalOpened=!1})}init()}]),buildApp.factory("buildListService",function($http){var buildListAPI={};return buildListAPI.getData=function(){return $http.get("/buildList")},buildListAPI.getResults=function(id){return console.log(id),$http.get("/buildList/item")},buildListAPI}),buildApp.controller("buildListController",["$scope","$q","$interval","buildListService",function($scope,$q,$interval,buildListService){function init(){getData(),$q.when(deferred.promise,function(){updateBuildsInterval=$interval(updateBuildsList,intervalTime)})}function getData(){return buildListService.getData().then(function(response){$scope.buildList=response.data,deferred.resolve()})}function setStatusOnJob(job,percentage){if(percentage>=100){var random=Math.round(Math.random());return job.status=random?"complete":"rejected",void(job.percentage=100)}job.status="running",job.percentage=percentage}function setStatusOfProcess(statesArr){var state;return state=statesArr.indexOf("running")>-1?"running":statesArr.indexOf("rejected")>-1?"rejected":"complete"}function updateJob(job,defered){if("complete"===job.status||"rejected"===job.status)return void defered.resolve(job.status);var estimatedTime=1e3*job.estimatedTime,percentage=parseInt(100*timeElapsed/estimatedTime,10);setStatusOnJob(job,percentage),defered.resolve(job.status)}function updateFirewall(firewall,firewallDefered){if("complete"===firewall.status||"rejected"===firewall.status)return void firewallDefered.resolve();var jobsDeferals=[],jobsStates=[];firewall.status="running",angular.forEach(firewall.jobs,function(job){var jDefered=$q.defer();jobsDeferals.push(jDefered.promise),updateJob(job,jDefered)}),$q.all(jobsDeferals).then(function(){angular.forEach(firewall.jobs,function(job){jobsStates.push(job.status)}),firewall.status=setStatusOfProcess(jobsStates),firewallDefered.resolve()})}function updateBuild(build,buildDefered){if("complete"===build.status||"rejected"===build.status)return void buildDefered.resolve();var firewallsPromises=[];angular.forEach(build.firewalls,function(firewall){var firewallDefered=$q.defer();firewallsPromises.push(firewallDefered.promise),updateFirewall(firewall,firewallDefered)}),$q.all(firewallsPromises).then(function(){var fStates=[],buildJobs={metrics:{percentage:0,status:[]},build:{percentage:0,status:[]},unitTest:{percentage:0,status:[]},functionalTest:{percentage:0,status:[]}};angular.forEach(build.firewalls,function(firewall){fStates.push(firewall.status),angular.forEach(firewall.jobs,function(job,jobName){buildJobs[jobName].percentage+=job.percentage,buildJobs[jobName].status.push(job.status)})}),angular.forEach(buildJobs,function(value){value.percentage=parseInt(value.percentage/build.firewalls.length,10),value.status=setStatusOfProcess(value.status)}),build.jobs=buildJobs,build.status=setStatusOfProcess(fStates),buildDefered.resolve()})}function updateBuildsList(){timeElapsed+=intervalTime;var overallStatus="running",buildPromises=[];angular.forEach($scope.buildList,function(build){var buildDefered=$q.defer();buildPromises.push(buildDefered.promise),updateBuild(build,buildDefered)}),$q.all(buildPromises).then(function(){var buildStates=[];angular.forEach($scope.buildList,function(build){buildStates.push(build.status)}),overallStatus=setStatusOfProcess(buildStates),("complete"===overallStatus||"rejected"===overallStatus)&&$interval.cancel(updateBuildsInterval)})}var updateBuildsInterval,deferred=$q.defer(),intervalTime=5e3,timeElapsed=0;$scope.displayResults=function(item){return"complete"!==item.status&&"rejected"!==item.status?!1:(buildListService.getResults(item.id).then(function(response){item.results=response.data}),!0)},init()}]),buildApp.directive("buildList",function(){return{restrict:"E",replace:!0,templateUrl:"buildList/html/default.tmpl"}}),buildApp.directive("buildItem",function(){return{restrict:"E",replace:!0,scope:{itemType:"=",onExpand:"=",ngModel:"="},templateUrl:"buildItem/html/default.tmpl",link:function(scope){function expandItem(id){angular.forEach(scope.ngModel,function(value){value.expanded=value.id===id,angular.forEach(value.firewalls,function(vvalue){vvalue.expanded=vvalue.id===id})})}scope.displayResults=function(item){if(item.results&&item.expanded)return void(item.expanded=!1);if(scope.onExpand(item))expandItem(item.id);else{var modalMessage=item.type+" ("+item.id+") is currently "+item.status;scope.$emit("modal:open",{message:modalMessage})}}}}}),buildApp.directive("loader",function(){return{restrict:"E",replace:!0,scope:{itemJobs:"="},templateUrl:"loader/html/default.tmpl"}}),buildApp.directive("itemDetails",function(){return{restrict:"E",replace:!0,scope:{itemData:"="},templateUrl:"itemDetails/html/default.tmpl"}}),buildApp.directive("modal",["$rootScope","$document",function($rootScope,$document){return{restrict:"E",replace:!0,scope:{modalOpened:"=",textMessage:"="},templateUrl:"modal/html/default.tmpl",link:function(scope){function bindEvents(){$document.on("keyup",function(e){27===e.keyCode&&(scope.closeModal(),scope.$apply())})}function unBindEvents(){$document.off("keyup")}scope.closeModal=function(){scope.modalOpened=!1,scope.$emit("modal:closed"),unBindEvents()},scope.openModal=function(message){scope.modalOpened=!0,scope.textMessage=message,bindEvents()},$rootScope.$on("modal:open",function(e,data){scope.openModal(data.message)})}}}]);